<VirtualHost *:80>
    ServerName 365smartnegocio.com
    ServerAlias www.365smartnegocio.com
    
    ServerAdmin admin@365smartnegocio.com
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/365smartnegocio-error.log
    CustomLog ${APACHE_LOG_DIR}/365smartnegocio-access.log combined
    
    # Redirigir todo el tráfico HTTP a HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName 365smartnegocio.com
    ServerAlias www.365smartnegocio.com
    
    ServerAdmin admin@365smartnegocio.com
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/365smartnegocio-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/365smartnegocio-ssl-access.log combined
    
    # SSL Configuration (se actualizará con certbot)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    
    # Configuración SSL moderna
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on
    
    # Headers de seguridad
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Proxy a la API Node.js en puerto 2018
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Configuración del proxy
    <Location />
        ProxyPass http://localhost:2018/
        ProxyPassReverse http://localhost:2018/
        
        # Headers para el proxy
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
    </Location>
    
    # WebSocket support (si es necesario)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:2018/$1" [P,L]
    
    # Caché para archivos estáticos
    <FilesMatch "\.(jpg|jpeg|png|gif|svg|css|js|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
